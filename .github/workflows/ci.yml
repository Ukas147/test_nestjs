name: ğŸš€ Enterprise CI/CD Pipeline

on:
  push:
    branches: [ main, develop, 'feature/*', 'hotfix/*' ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Executa anÃ¡lise de seguranÃ§a diariamente Ã s 2h
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '22.x'
  # REGISTRY: ghcr.io  # Comentado - nÃ£o usando Docker
  # IMAGE_NAME: ${{ github.repository }}  # Comentado - nÃ£o usando Docker

jobs:
  # ğŸ” AnÃ¡lise de Qualidade e SeguranÃ§a
  quality-security:
    name: ğŸ” Quality & Security Analysis
    runs-on: ubuntu-latest
    outputs:
      quality-status: ${{ steps.quality-check.outcome }}
      security-status: ${{ steps.security-check.outcome }}
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Para anÃ¡lise de commits

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: ğŸ“¦ Install dependencies
      run: npm ci --prefer-offline --no-audit

    - name: ğŸ”’ Security audit
      id: security-check
      run: |
        echo "ğŸ” Verificando vulnerabilidades..."
        npm audit --audit-level=moderate --json > audit-results.json || true
        npm audit --audit-level=moderate || echo "âš ï¸ Vulnerabilidades encontradas"
      continue-on-error: true

    - name: ğŸ§¹ Code quality analysis
      id: quality-check
      run: |
        echo "ğŸ” Executando anÃ¡lise de qualidade..."
        npm run lint
        npm run format -- --check
        npx tsc --noEmit
        echo "âœ… AnÃ¡lise de qualidade concluÃ­da"

    - name: ğŸ“Š Dependency analysis
      run: |
        echo "ğŸ“Š Analisando dependÃªncias..."
        npx npm-check-updates --format group
        echo "ğŸ“ˆ DependÃªncias desatualizadas:"
        npx outdated || echo "âœ… Todas as dependÃªncias estÃ£o atualizadas"

    - name: ğŸ“ Commit message validation
      run: |
        echo "ğŸ“ Validando mensagens de commit..."
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "âœ… Pull request - validaÃ§Ã£o de commit nÃ£o necessÃ¡ria"
        else
          echo "ğŸ” Validando commits..."
          # ValidaÃ§Ã£o bÃ¡sica de mensagens de commit
          git log --oneline -n 5 | while read line; do
            if [[ ! $line =~ ^[a-f0-9]{7} ]]; then
              echo "âŒ Commit invÃ¡lido: $line"
              exit 1
            fi
          done
        fi

    - name: ğŸš¨ Upload security results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-audit-results
        path: audit-results.json
        retention-days: 30

  # ğŸ§ª Testes e Coverage
  test:
    name: ğŸ§ª Comprehensive Testing
    runs-on: ubuntu-latest
    needs: quality-security
    if: needs.quality-security.outputs.quality-status == 'success'
    
    strategy:
      matrix:
        node-version: [18.x, 22.x]
        test-type: [unit, integration]
      fail-fast: false

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci --prefer-offline

    - name: ğŸ—„ï¸ Setup test database
      run: |
        npx prisma generate
        npx prisma db push
      env:
        DATABASE_URL: "file:./test-${{ matrix.node-version }}.db"

    - name: ğŸ§ª Run unit tests
      if: matrix.test-type == 'unit'
      run: |
        npm run test -- --coverage --maxWorkers=2
      env:
        DATABASE_URL: "file:./test-${{ matrix.node-version }}.db"

    - name: ğŸ§ª Run integration tests
      if: matrix.test-type == 'integration'
      run: |
        npm run test:e2e -- --coverage
      env:
        DATABASE_URL: "file:./test-${{ matrix.node-version }}.db"

    - name: ğŸ“Š Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-${{ matrix.node-version }}-${{ matrix.test-type }}
        path: coverage/
        retention-days: 30

  # ğŸ—ï¸ Build e ValidaÃ§Ã£o
  build:
    name: ğŸ—ï¸ Build & Validation
    runs-on: ubuntu-latest
    needs: [quality-security, test]
    if: needs.quality-security.outputs.quality-status == 'success'
    
    outputs:
      build-version: ${{ steps.version.outputs.version }}
      build-hash: ${{ steps.hash.outputs.hash }}

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci --prefer-offline

    - name: ğŸ”§ Generate Prisma client
      run: npx prisma generate
      env:
        DATABASE_URL: "file:./build-test.db"

    - name: ğŸ—ï¸ Build application
      run: |
        echo "ğŸ—ï¸ Iniciando build..."
        npm run build
        echo "âœ… Build concluÃ­do"

    - name: ğŸ“‹ Validate build artifacts
      run: |
        echo "ğŸ“‹ Validando artefatos do build..."
        test -f dist/src/main.js && echo "âœ… main.js encontrado" || exit 1
        test -d dist/src/modules && echo "âœ… mÃ³dulos compilados" || exit 1
        test -d dist/src/shared && echo "âœ… shared compilado" || exit 1
        
        echo "ğŸ“Š EstatÃ­sticas do build:"
        find dist/ -name "*.js" | wc -l | xargs echo "Arquivos JS:"
        du -sh dist/ | xargs echo "Tamanho total:"
        
        echo "ğŸ” Verificando imports:"
        grep -r "import\|require" dist/src/ | wc -l | xargs echo "Imports encontrados:"

    - name: ğŸ·ï¸ Generate version info
      id: version
      run: |
        echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
        echo "âœ… VersÃ£o: $(node -p "require('./package.json').version")"

    - name: ğŸ”‘ Generate build hash
      id: hash
      run: |
        echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "âœ… Hash: $(git rev-parse --short HEAD)"

    - name: ğŸ“¦ Create build artifact
      run: |
        tar -czf build-artifact.tar.gz dist/ package.json package-lock.json
        echo "ğŸ“¦ Artefato criado: build-artifact.tar.gz"

    - name: ğŸš€ Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: build-artifact-${{ steps.hash.outputs.hash }}
        path: build-artifact.tar.gz
        retention-days: 90

  # ğŸ³ CONTAINER BUILD - COMENTADO (nÃ£o necessÃ¡rio para este projeto)
  # container:
  #   name: ğŸ³ Container Build
  #   runs-on: ubuntu-latest
  #   needs: build
  #   if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
  #   
  #   steps:
  #   - name: ğŸ“¥ Checkout cÃ³digo
  #     uses: actions/checkout@v4

  #   - name: ğŸ³ Set up Docker Buildx
  #     uses: docker/setup-buildx-action@v3

  #   - name: ğŸ” Login to Container Registry
  #     uses: docker/login-action@v3
  #     with:
  #       registry: ${{ env.REGISTRY }}
  #       username: ${{ github.actor }}
  #       password: ${{ secrets.GITHUB_TOKEN }}

  #   - name: ğŸ“¦ Download build artifact
  #     uses: actions/download-artifact@v4
  #     with:
  #       name: build-artifact-${{ needs.build.outputs.build-hash }}
  #       path: ./dist

  #   - name: ğŸ·ï¸ Extract metadata
  #     id: meta
  #     uses: docker/metadata-action@v5
  #     with:
  #       images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
  #       tags: |
  #         type=ref,event=branch
  #         type=ref,event=pr
  #         type=sha,prefix={{branch}}-
  #         type=raw,value=latest,enable={{is_default_branch}}

  #   - name: ğŸ³ Build and push Docker image
  #     uses: docker/build-push-action@v5
  #     with:
  #       context: .
  #       push: true
  #       tags: ${{ steps.meta.outputs.tags }}
  #       labels: ${{ steps.meta.outputs.labels }}
  #       cache-from: type=gha
  #       cache-to: type=gha,mode=max

  # ğŸ“Š Coverage Report
  coverage:
    name: ğŸ“Š Coverage Analysis
    runs-on: ubuntu-latest
    needs: test
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ“Š Download coverage reports
      uses: actions/download-artifact@v4
      with:
        pattern: coverage-report-*
        path: coverage-reports/

    - name: ğŸ“ˆ Generate coverage summary
      run: |
        echo "ğŸ“Š RelatÃ³rio de Coverage:"
        find coverage-reports/ -name "lcov.info" -exec echo "Arquivo encontrado: {}" \;
        echo "âœ… RelatÃ³rio de coverage gerado"

    - name: ğŸš€ Upload to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage-reports/*/lcov.info
        flags: unittests,integration
        name: codecov-umbrella
        fail_ci_if_error: false
        verbose: true

  # ğŸš¨ Notifications
  notify:
    name: ğŸš¨ Notifications
    runs-on: ubuntu-latest
    needs: [quality-security, test, build]
    if: always()
    
    steps:
    - name: ğŸ“¢ Success notification
      if: needs.quality-security.outputs.quality-status == 'success' && needs.test.result == 'success' && needs.build.result == 'success'
      run: |
        echo "ğŸ‰ Pipeline executado com sucesso!"
        echo "âœ… Qualidade: Aprovada"
        echo "âœ… Testes: Aprovados"
        echo "âœ… Build: Aprovado"

    - name: ğŸš¨ Failure notification
      if: needs.quality-security.outputs.quality-status == 'failure' || needs.test.result == 'failure' || needs.build.result == 'failure'
      run: |
        echo "âŒ Pipeline falhou!"
        echo "ğŸ” Verifique os logs para mais detalhes"
        exit 1