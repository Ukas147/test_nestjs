name: ğŸ§ª Daily Complete Tests

on:
  schedule:
    # Executa testes completos diÃ¡rios Ã s 9h da manhÃ£
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      test-type:
        description: 'Tipo de teste'
        required: true
        default: 'complete'
        type: choice
        options:
          - complete
          - quick
          - security-only

env:
  NODE_VERSION: '22.x'

jobs:
  # ğŸ” AnÃ¡lise de Qualidade e SeguranÃ§a DiÃ¡ria
  daily-quality-security:
    name: ğŸ” Daily Quality & Security
    runs-on: ubuntu-latest
    outputs:
      quality-status: ${{ steps.quality-check.outcome }}
      security-status: ${{ steps.security-check.outcome }}
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: ğŸ“¦ Install dependencies
      run: npm ci --prefer-offline --no-audit

    - name: ğŸ”’ Security audit
      id: security-check
      run: |
        echo "ğŸ” VerificaÃ§Ã£o diÃ¡ria de seguranÃ§a..."
        npm audit --audit-level=moderate --json > audit-results.json || true
        npm audit --audit-level=moderate || echo "âš ï¸ Vulnerabilidades encontradas"
      continue-on-error: true

    - name: ğŸ§¹ Code quality analysis
      id: quality-check
      run: |
        echo "ğŸ” AnÃ¡lise diÃ¡ria de qualidade..."
        npm run lint
        npm run format -- --check
        npx tsc --noEmit
        echo "âœ… AnÃ¡lise de qualidade concluÃ­da"

    - name: ğŸ“Š Dependency analysis
      run: |
        echo "ğŸ“Š AnÃ¡lise diÃ¡ria de dependÃªncias..."
        npx npm-check-updates --format group
        echo "ğŸ“ˆ DependÃªncias desatualizadas:"
        npx outdated || echo "âœ… Todas as dependÃªncias estÃ£o atualizadas"

  # ğŸ§ª Testes Completos DiÃ¡rios
  daily-tests:
    name: ğŸ§ª Daily Complete Tests
    runs-on: ubuntu-latest
    needs: daily-quality-security
    if: needs.daily-quality-security.outputs.quality-status == 'success'
    
    strategy:
      matrix:
        node-version: [18.x, 22.x]
        test-type: [unit, integration]
      fail-fast: false

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v5

    - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci --prefer-offline

    - name: ğŸ—„ï¸ Setup test database
      run: |
        npx prisma generate
        npx prisma db push
      env:
        DATABASE_URL: "file:./test-${{ matrix.node-version }}.db"

    - name: ğŸ§ª Run unit tests
      if: matrix.test-type == 'unit'
      run: |
        npm run test -- --coverage --maxWorkers=2
      env:
        DATABASE_URL: "file:./test-${{ matrix.node-version }}.db"

    - name: ğŸ§ª Run integration tests
      if: matrix.test-type == 'integration'
      run: |
        npm run test:e2e -- --coverage
      env:
        DATABASE_URL: "file:./test-${{ matrix.node-version }}.db"

    - name: ğŸ“Š Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: daily-coverage-${{ matrix.node-version }}-${{ matrix.test-type }}
        path: coverage/
        retention-days: 7

  # ğŸ—ï¸ Build e ValidaÃ§Ã£o DiÃ¡ria
  daily-build:
    name: ğŸ—ï¸ Daily Build & Validation
    runs-on: ubuntu-latest
    needs: [daily-quality-security, daily-tests]
    if: needs.daily-quality-security.outputs.quality-status == 'success'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v5

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci --prefer-offline

    - name: ğŸ”§ Generate Prisma client
      run: npx prisma generate
      env:
        DATABASE_URL: "file:./build-test.db"

    - name: ğŸ—ï¸ Build application
      run: |
        echo "ğŸ—ï¸ Build diÃ¡rio..."
        npm run build
        echo "âœ… Build diÃ¡rio concluÃ­do"

    - name: ğŸ“‹ Validate build artifacts
      run: |
        echo "ğŸ“‹ Validando artefatos do build..."
        test -f dist/src/main.js && echo "âœ… main.js encontrado" || exit 1
        test -d dist/src/modules && echo "âœ… mÃ³dulos compilados" || exit 1
        test -d dist/src/shared && echo "âœ… shared compilado" || exit 1
        
        echo "ğŸ“Š EstatÃ­sticas do build diÃ¡rio:"
        find dist/ -name "*.js" | wc -l | xargs echo "Arquivos JS:"
        du -sh dist/ | xargs echo "Tamanho total:"

  # ğŸ“Š RelatÃ³rio DiÃ¡rio Completo
  daily-report:
    name: ğŸ“Š Daily Complete Report
    runs-on: ubuntu-latest
    needs: [daily-quality-security, daily-tests, daily-build]
    if: always()
    
    steps:
    - name: ğŸ“Š Generate comprehensive daily report
      run: |
        echo "ğŸ“Š RELATÃ“RIO DIÃRIO COMPLETO - $(date)"
        echo "=========================================="
        echo "ğŸ” Qualidade: ${{ needs.daily-quality-security.outputs.quality-status }}"
        echo "ğŸ›¡ï¸ SeguranÃ§a: ${{ needs.daily-quality-security.outputs.security-status }}"
        echo "ğŸ§ª Testes: ${{ needs.daily-tests.result }}"
        echo "ğŸ—ï¸ Build: ${{ needs.daily-build.result }}"
        echo ""
        echo "ğŸ“ˆ Status Geral:"
        if [ "${{ needs.daily-quality-security.outputs.quality-status }}" = "success" ] && [ "${{ needs.daily-tests.result }}" = "success" ] && [ "${{ needs.daily-build.result }}" = "success" ]; then
          echo "âœ… PROJETO SAUDÃVEL"
        else
          echo "âŒ PROJETO COM PROBLEMAS"
        fi
        echo ""
        echo "â° Executado em: $(date)"
        echo "ğŸ•˜ HorÃ¡rio: 9h da manhÃ£"
        echo "ğŸ“… FrequÃªncia: DiÃ¡ria"
